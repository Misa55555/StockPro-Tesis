{% extends 'base.html' %}
{% load static %}
{% load l10n %}

{% block title %}{{ titulo|default:"Dashboard" }}{% endblock title %}

{% block content %}
<div class="container-fluid">

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ titulo }}</h1>
        <div class="d-flex align-items-center">
            <div class="me-2">
                <label for="startDate" class="form-label-sm">Desde:</label>
                <input type="date" id="startDate" class="form-control form-control-sm" value="{{ fecha_inicio_mes|date:'Y-m-d' }}">
            </div>
            <div class="me-2">
                <label for="endDate" class="form-label-sm">Hasta:</label>
                <input type="date" id="endDate" class="form-control form-control-sm" value="{{ fecha_hoy|date:'Y-m-d' }}">
            </div>
            <button id="filterButton" class="btn btn-primary btn-sm align-self-end me-2">Filtrar</button>
            <button type="button" class="btn btn-success btn-sm align-self-end" data-bs-toggle="modal" data-bs-target="#gastoModal">
                <i class="fas fa-plus"></i> Registrar Gasto
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4"><div class="card border-left-success shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-success text-uppercase mb-1">Beneficio Neto</div><div id="kpi-beneficio-neto" class="h5 mb-0 font-weight-bold text-gray-800">$0.00</div></div><div class="col-auto"><i class="fas fa-dollar-sign fa-2x text-gray-300"></i></div></div></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card border-left-primary shadow h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Ingresos Brutos</div><div id="kpi-ingresos" class="h5 mb-0 font-weight-bold text-gray-800">$0.00</div></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card border-left-info shadow h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-info text-uppercase mb-1">Ganancia Bruta (Margen)</div><div id="kpi-ganancia-bruta" class="h5 mb-0 font-weight-bold text-gray-800">$0.00</div></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card border-left-danger shadow h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Gastos Operativos</div><div id="kpi-gastos" class="h5 mb-0 font-weight-bold text-gray-800">$0.00</div></div></div></div>
    </div>

    <div class="row">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Evolución de Ingresos vs Gastos</h6></div>
                <div class="card-body"><div class="chart-area"><canvas id="evolucionChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Gastos por Categoría</h6></div>
                <div class="card-body"><div class="chart-pie pt-4"><canvas id="gastosChart"></canvas></div></div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-xl-4 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Top 5 Productos (Más Vendidos)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar" style="height: 250px;">
                        <canvas id="topProductosVentaChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">Top 5 Productos (Más Rentables)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar" style="height: 250px;">
                        <canvas id="topProductosRentablesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">Ventas por Vendedor</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar" style="height: 250px;">
                        <canvas id="ventasPorVendedorChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Ventas por Categoría de Producto</h6></div>
                <div class="card-body"><div class="chart-pie pt-4"><canvas id="ventasCategoriaChart"></canvas></div></div>
            </div>
        </div>
    </div>

</div> <div class="modal fade" id="gastoModal" tabindex="-1" aria-labelledby="gastoModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="gastoModalLabel">Registrar Nuevo Gasto</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><form id="gastoForm" method="POST" action="{% url 'finanzas_app:registrar_gasto' %}"><div class="modal-body">{% csrf_token %}<div class="mb-3"><label for="{{ gasto_form.categoria.id_for_label }}" class="form-label">{{ gasto_form.categoria.label }}</label><div class="input-group">{{ gasto_form.categoria }}<button class="btn btn-outline-success" type="button" data-bs-toggle="modal" data-bs-target="#categoriaGastoModal" title="Nueva Categoría"><i class="fas fa-plus"></i></button></div></div><div class="mb-3"><label for="{{ gasto_form.monto.id_for_label }}" class="form-label">{{ gasto_form.monto.label }}</label>{{ gasto_form.monto }}</div><div class="mb-3"><label for="{{ gasto_form.fecha_imputacion.id_for_label }}" class="form-label">{{ gasto_form.fecha_imputacion.label }}</label>{{ gasto_form.fecha_imputacion }}</div><div class="mb-3"><label for="{{ gasto_form.descripcion.id_for_label }}" class="form-label">{{ gasto_form.descripcion.label }}</label>{{ gasto_form.descripcion }}</div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary" id="guardarGastoBtn">Guardar Gasto</button></div></form></div></div></div>
<div class="modal fade" id="categoriaGastoModal" tabindex="-1" aria-labelledby="categoriaGastoModalLabel" aria-hidden="true"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="categoriaGastoModalLabel">Nueva Categoría</h5><button type="button" class="btn-close" data-bs-toggle="modal" data-bs-target="#gastoModal" aria-label="Close"></button></div><form id="categoriaGastoForm" method="POST" action="{% url 'finanzas_app:registrar_categoria_gasto' %}"><div class="modal-body">{% csrf_token %}<div class="mb-3"><label for="{{ categoria_gasto_form.nombre.id_for_label }}" class="form-label">{{ categoria_gasto_form.nombre.label }}</D><label>{{ categoria_gasto_form.nombre }}</div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#gastoModal">Cancelar</button><button type="submit" class="btn btn-primary" id="guardarCategoriaGastoBtn">Guardar</button></div></form></div></div></div>
{% endblock content %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Variables globales
    let evolucionChartInstance = null;
    let gastosChartInstance = null;
    let ventasCategoriaChartInstance = null;
    let gastoModalInstance = null;
    let categoriaGastoModalInstance = null;
    
    let topProductosVentaChartInstance = null;
    let topProductosRentablesChartInstance = null;
    let ventasPorVendedorChartInstance = null;

    // URLs de la API
    const API_URL = "{% url 'finanzas_app:api_data' %}";
    const GASTO_FORM_URL = "{% url 'finanzas_app:registrar_gasto' %}";
    const CATEGORIA_GASTO_FORM_URL = "{% url 'finanzas_app:registrar_categoria_gasto' %}";

    // Función para formatear moneda
    function formatCurrency(value) {
        return parseFloat(value).toLocaleString('es-AR', {
            style: 'currency', currency: 'ARS', minimumFractionDigits: 2, maximumFractionDigits: 2
        });
    }

    // Función para cargar datos del dashboard (¡MODIFICADA!)
    async function fetchDataAndDrawCharts() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const url = `${API_URL}?start=${startDate}&end=${endDate}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error ${response.status}: ${errorData.error || 'Error desconocido'}`);
            }
            const data = await response.json();
            
            updateKPIs(data.kpis);
            drawEvolucionChart(data.charts.evolucion_ingresos_gastos);
            drawGastosChart(data.charts.gastos_por_categoria);
            drawVentasCategoriaChart(data.charts.ventas_por_categoria);
            
            // --- ¡INICIO DE LA CORRECCIÓN! ---
            // Ahora pasamos el *nombre* de la variable (como string) a la función.
            drawRankingChart(
                'topProductosVentaChart',
                'topProductosVentaChartInstance', // <-- Con comillas
                'Top 5 Vendidos (Cantidad)',
                data.charts.top_productos_venta,
                '#4e73df',
                false
            );
            
            drawRankingChart(
                'topProductosRentablesChart',
                'topProductosRentablesChartInstance', // <-- Con comillas
                'Top 5 Rentables (Ganancia)',
                data.charts.top_productos_rentables,
                '#1cc88a',
                true
            );
            
            drawRankingChart(
                'ventasPorVendedorChart',
                'ventasPorVendedorChartInstance', // <-- Con comillas
                'Ventas por Vendedor',
                data.charts.ventas_por_vendedor,
                '#36b9cc',
                true
            );
            // --- ¡FIN DE LA CORRECCIÓN! ---
            
        } catch (error) {
            console.error("Error al cargar datos del dashboard:", error);
            Swal.fire({
                icon: 'error',
                title: 'Error al cargar datos',
                text: `No se pudieron cargar los datos del dashboard. Revisa la consola.\nError: ${error.message}`,
            });
        }
    }

    // Función para actualizar KPIs (Sin cambios)
    function updateKPIs(kpis) {
        document.getElementById('kpi-beneficio-neto').textContent = formatCurrency(kpis.beneficio_neto);
        document.getElementById('kpi-ingresos').textContent = formatCurrency(kpis.total_ingresos);
        document.getElementById('kpi-ganancia-bruta').textContent = formatCurrency(kpis.ganancia_bruta);
        document.getElementById('kpi-gastos').textContent = formatCurrency(kpis.total_gastos);
    }

    // (Funciones de dibujo de gráficos: evolucion, gastos, ventasCategoria - sin cambios)
    function drawEvolucionChart(chartData) {
        const ctx = document.getElementById('evolucionChart').getContext('2d');
        if (evolucionChartInstance) {
            evolucionChartInstance.destroy();
        }
        evolucionChartInstance = new Chart(ctx, {
            type: 'line', data: { labels: chartData.labels, datasets: [{ label: "Ingresos", data: chartData.ingresos_data, borderColor: 'rgba(78, 115, 223, 1)', backgroundColor: 'rgba(78, 115, 223, 0.1)', fill: true, tension: 0.1 }, { label: "Gastos", data: chartData.gastos_data, borderColor: 'rgba(231, 74, 59, 1)', backgroundColor: 'rgba(231, 74, 59, 0.1)', fill: true, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: function(value, index, values) { return formatCurrency(value); } } } } }
        });
    }
    function drawGastosChart(chartData) {
        const ctx = document.getElementById('gastosChart').getContext('2d');
        if (gastosChartInstance) {
            gastosChartInstance.destroy();
        }
        gastosChartInstance = new Chart(ctx, {
            type: 'pie', data: { labels: chartData.labels, datasets: [{ data: chartData.data, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69', '#f8f9fc', '#e63946', '#a8dadc'], }] }, options: { responsive: true, maintainAspectRatio: false, }
        });
    }
    function drawVentasCategoriaChart(chartData) {
        const ctx = document.getElementById('ventasCategoriaChart').getContext('2d');
        if (ventasCategoriaChartInstance) {
            ventasCategoriaChartInstance.destroy();
        }
        ventasCategoriaChartInstance = new Chart(ctx, {
            type: 'doughnut', data: { labels: chartData.labels, datasets: [{ data: chartData.data, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69', '#f8f9fc', '#e63946', '#a8dadc'], }] }, options: { responsive: true, maintainAspectRatio: false, }
        });
    }
    
    // --- ¡NUEVO! Función genérica para dibujar los gráficos de ranking (¡CORREGIDA!) ---
    /**
     * Dibuja un gráfico de barras horizontal para los rankings.
     * @param {string} canvasId - ID del <canvas>
     * @param {string} chartInstanceName - ¡Nombre (string) de la variable global!
     * @param {string} label - Etiqueta para el dataset
     * @param {object} chartData - Objeto { labels: [], data: [] }
     * @param {string} color - Color hexadecimal para las barras
     * @param {boolean} isCurrency - Si el eje X debe formatearse como moneda
     */
    function drawRankingChart(canvasId, chartInstanceName, label, chartData, color, isCurrency) {
        // --- ¡INICIO DE LA CORRECCIÓN! ---
        // Ahora usamos el 'chartInstanceName' (string) para acceder a la variable global
        let instance = window[chartInstanceName]; 
        // --- ¡FIN DE LA CORRECCIÓN! ---
        
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (instance) {
            instance.destroy();
        }
        
        const options = {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: label,
                    data: chartData.data,
                    backgroundColor: color,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Horizontal
                scales: {
                    x: {
                        ticks: {}
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        };
        
        if (isCurrency) {
            options.options.scales.x.ticks.callback = function(value) {
                return formatCurrency(value);
            };
        }

        // --- ¡INICIO DE LA CORRECCIÓN! ---
        // Guardamos el gráfico en la variable global usando su nombre
        window[chartInstanceName] = new Chart(ctx, options);
        // --- ¡FIN DE LA CORRECCIÓN! ---
    }


    // --- (Funciones para parsear errores de Django - sin cambios) ---
    function parseDjangoErrors(jsonErrors) {
        try {
            const errors = JSON.parse(jsonErrors);
            let errorHtml = '<ul class="text-start">';
            for (const field in errors) {
                errors[field].forEach(error => {
                    const fieldName = (field === '__all__') ? '' : `<strong>${field}:</strong> `;
                    errorHtml += `<li>${fieldName}${error.message}</li>`;
                });
            }
            errorHtml += '</ul>';
            return errorHtml;
        } catch(e) {
            return "Error desconocido. Revisa la consola.";
        }
    }

    // --- (Lógica de Modales con SweetAlert - sin cambios) ---
    async function handleGastoSubmit(event) {
        event.preventDefault(); 
        const form = event.target;
        const formData = new FormData(form);
        const submitButton = document.getElementById('guardarGastoBtn');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
        try {
            const response = await fetch(GASTO_FORM_URL, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const data = await response.json();
            if (response.ok) {
                gastoModalInstance.hide();
                form.reset();
                Swal.fire({ icon: 'success', title: '¡Gasto Registrado!', timer: 1500, showConfirmButton: false });
                fetchDataAndDrawCharts();
            } else {
                Swal.fire({ icon: 'error', title: 'Error de Validación', html: parseDjangoErrors(data.errors) });
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error de Red', text: 'Error de red o del servidor. Intenta de nuevo.' });
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Guardar Gasto';
        }
    }
    async function handleCategoriaGastoSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const submitButton = document.getElementById('guardarCategoriaGastoBtn');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try {
            const response = await fetch(CATEGORIA_GASTO_FORM_URL, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const data = await response.json();
            if (response.ok) {
                categoriaGastoModalInstance.hide();
                form.reset();
                const selectCategoria = document.getElementById('id_categoria');
                const newOption = new Option(data.categoria_nombre, data.categoria_id, true, true);
                selectCategoria.add(newOption);
                gastoModalInstance.show();
            } else {
                Swal.fire({ icon: 'error', title: 'Error de Validación', html: parseDjangoErrors(data.errors) });
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error de Red', text: 'Error de red o del servidor. Intenta de nuevo.' });
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Guardar';
        }
    }
    
    // --- Ejecución (sin cambios) ---
    document.addEventListener('DOMContentLoaded', () => {
        const gastoModalEl = document.getElementById('gastoModal');
        const categoriaGastoModalEl = document.getElementById('categoriaGastoModal');
        gastoModalInstance = new bootstrap.Modal(gastoModalEl);
        categoriaGastoModalInstance = new bootstrap.Modal(categoriaGastoModalEl);
        const gastoForm = document.getElementById('gastoForm');
        gastoForm.addEventListener('submit', handleGastoSubmit);
        const categoriaGastoForm = document.getElementById('categoriaGastoForm');
        categoriaGastoForm.addEventListener('submit', handleCategoriaGastoSubmit);
        gastoModalEl.addEventListener('hidden.bs.modal', () => { gastoForm.reset(); });
        categoriaGastoModalEl.addEventListener('hidden.bs.modal', () => { categoriaGastoForm.reset(); });
        fetchDataAndDrawCharts();
        document.getElementById('filterButton').addEventListener('click', fetchDataAndDrawCharts);
    });

</script>
{% endblock extra_js %}