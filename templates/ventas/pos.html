{% extends 'base.html' %}
{% load static %}

{% block title %}Punto de Venta (POS){% endblock title %}

{% block content %}
<div class="container-fluid">
    <div class="row">

        <div class="col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Productos</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" id="product-search-input" class="form-control" placeholder="Buscar producto por nombre o código de barras...">
                    </div>
                    
                    <div id="product-list-container" class="list-group" style="max-height: 60vh; overflow-y: auto;">
                        {% for producto in productos %}
                        <a href="#" class="list-group-item list-group-item-action product-item" 
                           data-product-id="{{ producto.id }}" 
                           data-product-name="{{ producto.nombre }}" 
                           data-product-price="{{ producto.precio_venta }}"
                           data-product-stock="{{ producto.stock_total }}"
                           data-product-barcode="{{ producto.codigo_barras|default_if_none:'' }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ producto.nombre }}</h5>
                                <small class="font-weight-bold">${{ producto.precio_venta|floatformat:2 }}</small>
                            </div>
                            <div class="d-flex w-100 justify-content-between">
                                <p class="mb-1 text-muted">{{ producto.marca.nombre }} - {{ producto.categoria.nombre }}</p>
                                <p class="mb-1">
                                    Stock: <span class="font-weight-bold {% if producto.stock_total <= producto.stock_minimo %}text-danger{% else %}text-success{% endif %}">{{ producto.stock_total|floatformat:0 }}</span>
                                </p>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Ticket Actual</h6>
                </div>
                <div class="card-body" id="ticket-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>Cliente:</strong>
                            <span id="ticket-customer-name">Consumidor Final</span>
                        </div>
                        <button class="btn btn-sm btn-info" id="assign-customer-btn">Asignar/Crear Cliente</button>
                    </div>
                    <hr>
                    
                    <div id="ticket-items-container" style="min-height: 30vh; max-height: 30vh; overflow-y: auto;">
                        <p class="text-center text-muted py-5">Añada productos al ticket</p>
                    </div>
                    
                    <div class="mt-3 bg-light p-3 rounded">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="ticket-subtotal" class="fw-bold">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Descuento ($):</span>
                            <div style="width: 130px;">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">$</span>
                                    <input type="number" id="discount-input" class="form-control text-end" min="0" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h3 class="d-flex justify-content-between align-items-center font-weight-bold">
                            Total a Pagar:
                            <span id="ticket-total-amount" class="text-success">$0.00</span>
                        </h3>
                    </div>

                    <div class="mt-4">
                        <div class="form-group mb-3">
                            <label for="payment-method-select" class="form-label fw-bold">Método de Pago</label>
                            <select id="payment-method-select" class="form-select form-select-lg">
                                {% for metodo in metodos_pago %}
                                <option value="{{ metodo.id }}">{{ metodo.nombre }}</option>
                                {% empty %}
                                <option value="" disabled selected>No hay métodos de pago</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button class="btn btn-success btn-lg w-100 py-3" id="pay-button">
                            <i class="fas fa-cash-register"></i> PAGAR / COBRAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', function () {
        const productSearchInput = document.getElementById('product-search-input');
        const productListContainer = document.getElementById('product-list-container');
        const ticketItemsContainer = document.getElementById('ticket-items-container');
        
        // Referencias nuevas para totales
        const ticketSubtotal = document.getElementById('ticket-subtotal');
        const ticketTotalAmount = document.getElementById('ticket-total-amount');
        const discountInput = document.getElementById('discount-input');

        const payButton = document.getElementById('pay-button');
        const allProductItems = Array.from(productListContainer.getElementsByClassName('product-item'));
        const assignCustomerBtn = document.getElementById('assign-customer-btn');
        const mainModalEl = document.getElementById('mainModal');
        const mainModal = new bootstrap.Modal(mainModalEl);
        const modalContentWrapper = document.getElementById('modal-content-wrapper');
        const ticketCustomerName = document.getElementById('ticket-customer-name');

        // ESTADO DEL TICKET (ACTUALIZADO CON DESCUENTO)
        let posTicket = {
            items: {},
            subtotal: 0,
            discount: 0,
            total: 0,
            clienteId: null,
            metodoPagoId: null
        };
        
        function addProductToTicket(product) {
            const stock = parseFloat(product.stock);
            const currentQuantity = posTicket.items[product.id] ? posTicket.items[product.id].quantity : 0;

            if (currentQuantity >= stock) {
                Swal.fire({ icon: 'warning', title: 'Stock Agotado', text: `No hay más stock disponible para "${product.name}".`});
                return;
            }

            if (posTicket.items[product.id]) {
                posTicket.items[product.id].quantity++;
            } else {
                posTicket.items[product.id] = {
                    id: product.id,
                    name: product.name,
                    price: parseFloat(product.price),
                    stock: stock,
                    quantity: 1
                };
            }
            renderTicket();
        }
        
        function updateQuantity(productId, change) {
            const item = posTicket.items[productId];
            if (!item) return;

            const newQuantity = item.quantity + change;

            if (newQuantity > item.stock) {
                Swal.fire({ icon: 'warning', title: 'Límite de Stock', text: `No se puede vender más que el stock disponible (${item.stock}).`});
                return;
            }

            if (newQuantity <= 0) {
                delete posTicket.items[productId];
            } else {
                item.quantity = newQuantity;
            }
            renderTicket();
        }

        // FUNCIÓN DE RENDERIZADO (ACTUALIZADA CON CÁLCULOS)
        function renderTicket() {
            ticketItemsContainer.innerHTML = Object.keys(posTicket.items).length === 0 ? '<p class="text-center text-muted py-5">Añada productos al ticket</p>' : '';
            
            let newSubtotal = 0;
            for (const productId in posTicket.items) {
                const item = posTicket.items[productId];
                const lineTotal = item.quantity * item.price;
                newSubtotal += lineTotal;
                
                const itemHTML = `
                    <div class="ticket-item mb-2 p-2 border rounded bg-white" data-product-id="${item.id}">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">${item.name}</span>
                            <span class="fw-bold">$${lineTotal.toFixed(2)}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <small class="text-muted">$${item.price.toFixed(2)} c/u</small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary quantity-change" data-change="-1">-</button>
                                <span class="btn btn-light disabled" style="width: 40px;">${item.quantity}</span>
                                <button class="btn btn-outline-secondary quantity-change" data-change="1">+</button>
                            </div>
                        </div>
                    </div>`;
                ticketItemsContainer.innerHTML += itemHTML;
            }

            // Cálculos finales
            posTicket.subtotal = newSubtotal;
            
            // Evitar que el descuento sea mayor que el subtotal
            if (posTicket.discount > posTicket.subtotal) {
                posTicket.discount = posTicket.subtotal;
                discountInput.value = posTicket.discount.toFixed(2);
            }
            
            posTicket.total = Math.max(0, posTicket.subtotal - posTicket.discount);

            // Actualizar DOM
            ticketSubtotal.textContent = `$${posTicket.subtotal.toFixed(2)}`;
            ticketTotalAmount.textContent = `$${posTicket.total.toFixed(2)}`;
        }

        function selectClient(cliente) {
            posTicket.clienteId = cliente.id;
            ticketCustomerName.textContent = cliente.text.split(' - ')[0];
            mainModal.hide();
        }

        function printTicket() {
            const ticketToPrint = document.getElementById('ticket-to-print');
            if (ticketToPrint) {
                const originalPage = document.body.innerHTML;
                const printContent = ticketToPrint.innerHTML;
                document.body.innerHTML = `<div class="container p-4">${printContent}</div>`;
                window.print();
                document.body.innerHTML = originalPage;
                window.location.reload();
            }
        }

        // EVENT LISTENERS
        productSearchInput.addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            allProductItems.forEach(item => {
                const productName = item.dataset.productName.toLowerCase();
                const productBarcode = item.dataset.productBarcode.toLowerCase();
                item.style.display = (productName.includes(searchTerm) || productBarcode.includes(searchTerm)) ? 'block' : 'none';
            });
        });

        productListContainer.addEventListener('click', function(event) {
            const productItem = event.target.closest('.product-item');
            if (productItem) {
                event.preventDefault();
                const product = {
                    id: productItem.dataset.productId,
                    name: productItem.dataset.productName,
                    price: productItem.dataset.productPrice,
                    stock: productItem.dataset.productStock
                };
                addProductToTicket(product);
            }
        });

        ticketItemsContainer.addEventListener('click', function(event) {
            const button = event.target.closest('.quantity-change');
            if (button) {
                const productId = button.closest('.ticket-item').dataset.productId;
                const change = parseInt(button.dataset.change, 10);
                updateQuantity(productId, change);
            }
        });

        // LISTENER NUEVO PARA EL DESCUENTO
        discountInput.addEventListener('input', function(e) {
            let val = parseFloat(e.target.value);
            if (isNaN(val) || val < 0) val = 0;
            posTicket.discount = val;
            renderTicket();
        });

        assignCustomerBtn.addEventListener('click', function() {
            // (Tu lógica de cliente existente aquí, no cambia)
             fetch("{% url 'ventas_app:crear_cliente_modal' %}")
                .then(response => response.text())
                .then(html => {
                    modalContentWrapper.innerHTML = html;
                    mainModal.show();
                    $('#customer-search-select').select2({
                        dropdownParent: $(mainModalEl),
                        placeholder: 'Escribe un nombre o DNI...',
                        ajax: { url: "{% url 'ventas_app:buscar_clientes' %}", dataType: 'json', delay: 250, data: params => ({ term: params.term }), processResults: data => ({ results: data }) }
                    }).on('select2:select', e => selectClient(e.params.data));
                    modalContentWrapper.addEventListener('submit', function(e) {
                        if (e.target && e.target.id === 'create-customer-form') {
                            e.preventDefault();
                            fetch(e.target.action, { method: 'POST', body: new FormData(e.target), headers: { 'X-CSRFToken': csrftoken } })
                            .then(response => response.json())
                            .then(data => { if (data.status === 'success') { selectClient(data.cliente); } else { document.getElementById('create-customer-form-container').innerHTML = data.form_html; } });
                        }
                    });
                });
        });

        payButton.addEventListener('click', function() {
            posTicket.metodoPagoId = document.getElementById('payment-method-select').value;
            
            if (Object.keys(posTicket.items).length === 0) {
                Swal.fire({icon: 'error', title: 'Ticket Vacío', text: 'Añada productos antes de cobrar.'});
                return;
            }
            if (!posTicket.metodoPagoId) {
                Swal.fire({icon: 'error', title: 'Falta Método de Pago', text: 'Por favor, selecciona un método de pago.'});
                return;
            }
            
            // Deshabilitar botón para evitar doble cobro
            payButton.disabled = true;
            payButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

            fetch("{% url 'ventas_app:pos' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify(posTicket)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    modalContentWrapper.innerHTML = data.modal_html;
                    mainModal.show();
                    // Listeners para el modal de ticket
                    document.getElementById('new-sale-btn').addEventListener('click', () => window.location.reload());
                    document.getElementById('print-ticket-btn').addEventListener('click', printTicket);
                    // Forzar recarga al cerrar el modal manualmente también
                    mainModalEl.addEventListener('hidden.bs.modal', () => window.location.reload(), { once: true });

                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.message });
                    payButton.disabled = false;
                    payButton.innerHTML = '<i class="fas fa-cash-register"></i> PAGAR / COBRAR';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({ icon: 'error', title: 'Error Inesperado', text: 'Revisa la consola.' });
                payButton.disabled = false;
                payButton.innerHTML = '<i class="fas fa-cash-register"></i> PAGAR / COBRAR';
            });
        });

        renderTicket();
    });
</script>
{% endblock extra_js %}